upstream netdata
{
    # the Netdata server
    server 127.0.0.1:19999;
    keepalive 64;
}

upstream ntop_srv
{
    server 127.0.0.1:3000;
    keepalive 64;
}

server
{
    # nginx listens to this
    listen 80 default_server;

    # listen to everything
    server_name _;

    # NETDATA
    location /netdata
    {
        return 301 /netdata/;
    }

    gzip on;
    gzip_proxied any;
    gzip_types *;

    # NTOP
    location /ntop
    {
        return 301 /ntop/;
    }

    location /ntop/
    {
        proxy_pass http://ntop_srv;
    }

    # NETDATA
    location ~ /netdata/(?<ndpath>.*)
    {
        proxy_redirect off;
        proxy_set_header Host $host;

        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_pass_request_headers on;
        proxy_set_header Connection "keep-alive";
        proxy_store off;
        proxy_pass http://netdata/$ndpath$is_args$args;

    }

    # DEMOS
    root /var/www/demos/;
    index index.php index.html index.htm index.nginx-debian.html /_h5ai/public/index.php;

    if ($http_cf_ray = "")
    {
        return 444;
    }

    error_page 403 404 500 =301 https://$host;

    location ~ \.php$
    {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix://var/run/php/php8.0-fpm.sock;
        fastcgi_read_timeout 10;
    }

    location ~ /\.ht
    {
        deny all;
    }
}

